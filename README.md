# Top-5 soccer tournaments statistics

## Описание проекта
Сервис по предоставлению статистики по топ-5 футбольным лигам Европы.

### UI

Построен инструментом *Dash*, его страницы:
1. **Tables**:

    Страница с турнирными таблицами.

    Пользователь выбирает *сезон*  и *турнир* и получает:

    - турнирную таблицу;
        - график с забитыми/пропущенными голами каждой команды;
        - график числа побед/поражений каждой команы;
    - таблицу лучших бомбардиров;
        - график среднего числа минут на забитие гола всех игроков;
        - график среднего числа ударов на забитие гола всех игроков.
3. **Statistics**:
    Страница со статистикой команд.

    Пользователь выбирает *сезон*, *турнир* и *команду* и получает графики:
    - распределение забитых/пропущенных голов по минутам;
    - тотал забитых/пропущенных голов;
    - распределение полученных карточек по минутам;
    - рапределение схем выхода игровов на поле;
    - распределение "сухих" игр (игру без пробущенных голов);
    - распределение забитых/пропущенных пенальти.

3. **H2H**:
    Страница со сравнением статистик нескольких команд.

    Пользователь выбирает *турнир*, *команды* и *сезон* и получает сравнительные графики:
    - число побед/ничьих/проигрышей;
    - число набранных очков;
    - число забитых/пропущенных голов;
    - число полученных карточек (красных/желтых).
4. **Leagues**:

    Страница сравнения агрегированных статистик среди лиг.

    Пользователь выбирает *турниры* и *сезон* и получает сравнительные графики:
    - сумма забитых голов всеми командами за сезон в турнирах;
    - среднее число забитых голов командами в турнирах;
    - сумма полученных карточек всеми командами за сезон в турнирах;
    - среднее число полученных карточек командами в турнирах;
    - сумма игр без пропущенных голов командами в турнирахю.

**Код**:
1. `main.py` запуск соединения и построение взаимодействия с пользователем;
2. `utils_dash/...` скрипты для построения графиков для каждой из страниц.

### Работа с данными
#### Источник данных
Данные предоставляются сервисом [rapid-api](https://rapidapi.com/api-sports/api/api-football), нужно в нем зарегистрироваться и подписаться на api в предоставляемой ссылке.
#### Хранение
Для хранения выгружаемых данных используется база данных [PostgreSQL](https://www.postgresql.org/).

Используемые скрипты:
1. Взаимодействие с БД: `src/database_connection.py`;
1. Создание таблиц: `sql/create_tables/`;
2. Агрегация данных: `sql/aggregations/`.
#### Выгрузка и агрегирование
Данные выгружаются и агрегируются автоматически с регулярностью раз в день, при помощи оркестратора [Apache Airflow](https://airflow.apache.org/). 

Настроен даг `dags/statistics_update_dag.py`, который состоит из 2 тасков:
1. daily_statistics_update - *BashOperator*, зыпускающий выгрузку данных `src/data_extraction.py`
2. daily_aggregations_update - *BashOperator*, зыпускающий агрегацию выгруженных данных `src/statistics_aggregation.py`

## Конфигурация и запуск проекта

### Настройка окружения
```
cd ~/
git clone ...                                                                        # клонирование репозитория
cd soccer_api
python3 -m venv venv_soccer                                                          # создание окружения
source venv_soccer/bin/activate                 
pip install -r requirements.txt                                                      # установка зависимостей
cp conf/configs_template.yaml conf/configs.yaml && rm conf/configs_template.yaml     # удаляем суффикс _template из конфигов
```
### Подписка на api
1. Подписаться на [soccer-api](https://rapidapi.com/api-sports/api/api-football)
2. Внести credentials в файл с конфигурациями:
```
conf/configs.yaml:
    rapid_api:
        key: ...
        host: ...
```

### Создание БД
1. Создать пустой БД в PostgreSQL;
2. Внести credentials в файл с конфигурациями:
```
conf/configs.yaml:
    db:
        host: ...
        database: ...
        user: ...
        password: ...
        port: ...
```
### First run
1. Создаются необходимы таблицы в БД;
2. Производится первичная выгрузка данных и их агрегация
```
python3 src/tables_creation.py && python3 src/data_extraction.py data_extraction.first_run=True \
    && python3 src/statistics_aggregation.py data_extraction.first_run=True  
```
### AirFlow
#### Установка 
```
mkdir ~/airflow                                                       # создание домашней директории для AirFlow  
export AIRFLOW_HOME=~/airflow
pip install apache-airflow==2.8.0                                     # установка AirFlow
pip install apache-airflow-providers-postgres                         # установка Postgres provider для AirFlow

cp -r dags ~/airflow/                                                 # копируем папку dags в корневую директорию airflow
```
#### Настройка
Настройте AirFlow по [инструкции](https://stepik.org/lesson/1074008/step/14?auth=login&unit=1084080)

Внести credentials в файл с конфигурациями:
```
conf/configs.yaml:
    airflow:
      dag_args: 
         owner: ...
         email: ...  
```

#### Запуск
```
airflow standalone
```
## Dash
### Запуск
```
python3 main.py
```
    